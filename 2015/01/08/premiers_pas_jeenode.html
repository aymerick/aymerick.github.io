<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Premiers pas avec les JeeNode</title>
        <meta name="description" content="The personal website of a generalist developer living in France.">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/png" href="/favicon.png" />

        <link rel="alternate" type="application/rss+xml" title="Aymerick's stuff" href="http://www.aymerick.com/rss.xml">

        <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
        <link rel="stylesheet" href="/assets/css/syntax.css">
        <link rel="stylesheet" href="/assets/css/main.css">

        

        <!-- OG meta -->
        <meta property="og:title" content="Premiers pas avec les JeeNode" />
        
          <meta property="og:description" content="Ginette, vas-me chercher mes chaussures, j'vais sortir Ginaude." />
        

        
          <meta property="og:type" content="article" />
          
            
          
          
            
              <meta property="article:tag" content="jeenode" />
            
          
        
    </head>

    <body id="">
        <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
          <div class="container-fluid">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <a href="/index.html" class='navbar-brand'>Aymerick</a>
            </div>

            <div class="collapse navbar-collapse" id="navbar-collapse-1">
              <ul class="nav navbar-nav">
                <li class="">
                  <a href="/about.html">About</a>
                </li>
                <li class="">
                  <a href="/stuff.html">Stuff</a>
                </li>
              </ul>
            </div>
          </div>
        </nav>

        <div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="post-header">
              <h2 class='post-title'>Premiers pas avec les JeeNode</h2>
              
                <ul class="post-tags">
                  
                    <li><a href="/tags/#jeenode-ref">#jeenode</a></li>
                  
                </ul>
              
              <p class="meta">08 Jan 2015</p>
            </div>

            <div class="post">
            <p>Ami lecteur, te voilà en possession d&#39;un JeeNode que <a href="/2015/01/06/souder_jeenode.html">tu as soudé tout seul comme un grand</a>, et même si tu es content de toi, tu te dis que quand même ça serait pas mal d&#39;en faire quelque chose d&#39;utile.</p>

<p>Alors aujourd&#39;hui, ensemble, faisons communiquer deux JeeNode.</p>

<p>Mais avant tout j&#39;ai un aveux à te faire: je t&#39;ai menti. Oui je sais, c&#39;est mal, et depuis j&#39;ai un peu de mal à dormir.</p>

<h3>L&#39;aveux</h3>

<p>Je t&#39;expliquais donc qu&#39;<a href="/2015/01/05/plateforme_jeenode.html">il suffisait de deux JeeNode pour commencer</a>, et que tu n&#39;avais pas besoin de <a href="http://www.digitalsmarties.net/products/jeelink">JeeLink</a>. Disons que dans l&#39;absolu c&#39;est pas faux, mais pour tester c&#39;est quand même bien pratique de pouvoir connecter un JeeMachin sur son ordinateur de développement.</p>

<p>Personnellement j&#39;utilise donc un <a href="http://www.digitalsmarties.net/products/jeelink">JeeLink</a>, branché sur mon Mac:</p>

<p><img src="/img/jeenode/jeelink.jpg" alt="JeeLink"></p>

<h3>Giles Inc.</h3>

<p>Allez, je suis pas chien, je vais t&#39;expliquer comment ça marche.</p>

<p>Pour commencer, il faut installer <a href="http://arduino.cc/en/Main/Software">le dernier SDK Arduino</a>; en ce qui me concerne ça sera <em>Arduino 1.0.6</em> pour <em>MacOS X</em>.</p>

<p>Puis lance l&#39;IDE Arduino, et connecte le JeeLink sur un port USB de ton ordi.</p>

<p>Ensuite va dans <code>Outils &gt; Port série</code> et sélectionne <code>/dev/tty.usbserial-A1014IM4</code>:</p>

<p><img src="/img/jeelink/arduino_01.png" alt="Port série"></p>

<p>(si le JeeLink n&#39;est pas détecté, installe <a href="http://www.silabs.com/products/mcu/pages/usbtouartbridgevcpdrivers.aspx">ces drivers</a>)</p>

<p>Sélectionne <code>Outils &gt; Moniteur série</code>:</p>

<p><img src="/img/jeelink/arduino_02.png" alt="Moniteur série"></p>

<p>Une fenêtre s&#39;affiche: choisis <code>57600 baud</code> dans le menu déroulant en bas à droite de celle-ci.</p>

<p>Et là, normalement, le JeeLink essaie d&#39;entrer en communication avec toi:</p>

<p><img src="/img/jeelink/arduino_03.png" alt="RF12demo"></p>

<p>Si ce n&#39;est pas le cas, tappe <code>?</code> puis clique sur <code>Envoyer</code>. Si cela ne marche toujours pas débranche le JeeLink, rebranche le et relance le Moniteur série. Si cela ne marche toujours pas, envoie <strong>MOUISE</strong> au <strong>7 12 12</strong>.</p>

<p><code>¯\_(ツ)_/¯</code></p>

<p>Alors, par défaut tous les JeeNode et JeeLink sont flashés avec un programme (on parle de <strong>sketch</strong> pour un Arduino) qui s&#39;appelle, attention tiens-toi bien, le <a href="http://jeelabs.net/projects/jeelib/wiki/RF12demo">RF12demo</a>. Encore un bel exemple que:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">There are only two hard things in Computer Science: cache invalidation and naming things. -- Phil Karlton
</code></pre></div>
<p>Non mais <strong>demo</strong> ? Sérieux ? Alors en ce qui concerne les nodes &quot;capteurs&quot; on va en effet rapidement les flasher avec un autre sketch, mais on en a quand même besoin pour les configurer. Et puis on va par contre bel et bien garder ce sketch tel quel au niveau du node maitre. Du coup, <strong>demo</strong> je trouve que c&#39;est assez mal choisis pour du code qui est essentiel pour notre petit réseau domestique.</p>

<p>Bon, bref, j&#39;imagine que tout cela est historique, et sinon tu peux jeter un oeil au code source <a href="https://github.com/jcw/jeelib/blob/master/examples/RF12/RF12demo/RF12demo.ino">qui se trouve ici</a>.</p>

<p>Revenons à notre JeeLink qui vient de nous dire plein de choses super intéressantes. Il a commencé par un truc dans ce genre là:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">[RF12demo.7] A i1 g100 @ 915 Mhz
</code></pre></div>
<p>Ce qu&#39;on peut traduire par:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Wesh cousin, je suis le sketch RF12demo version 7 mon pote. Eh ouais ! Je suis le number 1 du crew 100 et je sent la vibe à 915Mhz.
</code></pre></div>
<p>Ce qu&#39;on peut traduire également par:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Je suis le node numéro 1 dans le groupe numéro 100 et je communique sur du 915Mhz.
</code></pre></div>
<p>Ensuite on a:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">DF I 795 9
</code></pre></div>
<p>Et ça autant te dire qu&#39;on s&#39;en fout complètement.</p>

<p>Après on a la liste des commandes que l&#39;on peut envoyer au JeeLink pour le configurer ou pour envoyer des packets de test.</p>

<p>On va donc commencer par le configurer correctement, en tappant des commandes dans la zone de saisie en haut de la fenêtre:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">15i
</code></pre></div>
<p>Cà c&#39;est pour dire &quot;tu seras le node numéro 15 mon fils&quot;...</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">8b
</code></pre></div>
<p>... &quot;et je t&#39;assure, tu communiques sur du 868Mhz, c&#39;est ce qui était marqué sur l&#39;emballage quand tu es né&quot;...</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">212g
</code></pre></div>
<p>... &quot;ah au fait ton nom de famille c&#39;est 212. Bienvenue dans notre famille fiston!&quot;</p>

<p>Une chose qu&#39;il faut que tu saches, c&#39;est que plus tard, quand ton réseau de JeeNode sera en place, il faudra faire en sorte que seul ton node maitre connecté au raspberry réponde aux autres nodes. Et il y aura donc une configuration supplémentaire à effectuer sur ton JeeLink de test:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">1c
</code></pre></div>
<p>La traduction étant: &quot;tu sais, tu es un peu spécial, tu est un JeeLink de test, et pour ne pas interférer avec les autres membres de la famille, je te met en mode <strong>collect</strong>, ce qui veut dire qu&#39;a partir de maintenant tu entendras bien ce que disent les autres nodes mais tu ne leur répondras jamais, je sais c&#39;est dûr mais c&#39;est tombé sur toi, c&#39;est comme ça, fait avec&quot;.</p>

<p>Pour l&#39;instant ce n&#39;est pas nécessaire.</p>

<p>Voilà, le JeeLink est configuré et gardera ses paramètres bien au chaud dans son EEPROM.</p>

<p>A chaque fois que ce JeeLink reçoit un message, il l&#39;affiche à l&#39;écran sur une seule ligne, genre comme ça:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">? 41 247 84 70 252 129 16 100 211 6 129 241 18 230 72 64 65 219 157 180 182
</code></pre></div>
<p>Tu remarqueras le <strong>?</strong> en début de ligne. Cela signifie que notre pote JeeLink n&#39;a rien compris. En gros il y a un appareil pas loin qui cause aussi sur le 868Mhz mais ce n&#39;est pas un JeeNode.</p>

<p>Si tu vois ce genre de choses apparaitre:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">OK 4 1 129 166 0
</code></pre></div>
<p>Le <strong>OK</strong> veut dire que le JeeLink a bien reçu un packet d&#39;un autre JeeNode.</p>

<h3>Live on RFM12B</h3>

<p>Alors, arrêtons nous un instant sur la façon dont ce réseau de JeeNode fonctionne.</p>

<p>Tu l&#39;as compris, il y a une histoire de groupes. On peut avoir 212 groupes de 31 nodes chacun.</p>

<p>Dans mon cas de figure, qui est je te le rappelle la mise en place de capteurs un peu partout chez moi, un node maitre (le node <strong>31</strong>) est branché en permanence sur un raspberry pi pour faire tourner le célèbre sketch RF12demo.</p>

<p>Les autres nodes, numérotés <strong>de 1 à 30</strong>, font tourner un sketch spécifique aux capteurs qu&#39;ils possèdent et envoient leurs données à intervalle régulier. Je configure toujours ces nodes pour qu&#39;ils demandent un acquittement; le node maitre doit est le seul à envoyer ces acquittements. C&#39;est pour cela que mon JeeLink de test est configuré en mode <strong>collect</strong>, pour ne pas interférer avec le node maitre.</p>

<p>Dans l&#39;exemple ci-dessous, on voit le node maitre <code>JeeNode 31</code> qui reçoit des données des deux JeeNode <code>JeeNode 1</code> et <code>JeeNode 2</code> possédant chacun un capteur de température, et il leur répond en envoyant un acquittement.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">      +----+      +----+
      |Temp|      |Temp|
      +----+      +----+
    +-+----+--+ +-+----+--+
    |JeeNode 1| |JeeNode 2|
    +----+----+ +-+-------+
         |        |
     temp| ^  temp| ^
         | |      | |
         | |      | |
         v |ack   v |ack
           |        |
       +---+--------+-+
       |  JeeNode 31  |
       | +----------+ |
       | |RFM12demo | |
       | +----------+ |
       +--------------+
              |
              |
              v
      +-----------------+
      |  Raspberry Pi   |
      |  +-----------+  |
      |  |RFM12demo  |  |
      |  |decoder    |  |
      |  +-----------+  |
      +-----------------+
                                                                
</code></pre></div>
<p>Si les nodes ne recoivent pas d&#39;acquittement, il réémettrons plusieurs fois avant d&#39;abandonner.</p>

<p>Soyons clair, le node maitre ne fait que transmettre les données brutes au raspberry. Il faut donc un programme qui décode les paquets reçus; c&#39;est le role du <code>RFM12demo decoder</code> sur le schéma. Notre ami <a href="/2015/01/05/plateforme_jeenode.html">Jean-Claude</a> a développé un outil pour jouer ce role: <a href="http://jeelabs.net/projects/housemon/wiki">HouseMon</a>. Alors autant te dire tout de suite, j&#39;ai installé une vieille version il y a bien longtemps qui ne m&#39;a pas vraiment emballé. Depuis ça a pas mal bougé, mais ça m&#39;a l&#39;air bien compliqué avec des histoires de <a href="https://github.com/jcw/jeebus">jeebus</a> et de <a href="https://github.com/jcw/flow">flow</a>... mMmm ok bon, ba <em>&quot;ça ne me plait pas donc je vais coder un truc à ma façon&quot; (tm)</em>.</p>

<p>Mais je vois qu&#39;une question te taraude. Que ce passe-t-il si on veut installer plus de 31 nodes chez soit ? Eh bien mon jeune ami, il faut mettre en place un deuxième groupe, et donc un deuxième node maitre pour ce groupe. On se retrouvera alors avec deux nodes maitres sur le raspberry pi, et le <code>RFM12demo decoder</code> devra prendre ça en compte.</p>

<h3>Bééééé !</h3>

<p>Revenons maintenant à nos moutons, ou plutôt à notre JeeLink de test. Essayons donc de le faire communiquer avec le JeeNode que <a href="/2015/01/06/souder_jeenode.html">tu as soudé</a>.</p>

<p>Allez, branche ton JeeNode sur ton ordinateur. Vas-y essaie. Tu n&#39;y arrives pas ? Ahah je suis taquin: il te faut un un <a href="http://www.digitalsmarties.net/products/usb-bub">USB BUB</a> pour relier le port FTDI du JeeNode au port USB de ton ordinateur:</p>

<p><img src="/img/jeenode/usb_bub.jpg" alt="USB HUB"></p>

<p>Donc maintenant tu peux y aller, branche ton JeeNode:</p>

<p><img src="/img/jeenode/usb_bub_con.jpg" alt="Jeenode avec USB HUB"></p>

<p>Les leds <strong>TX</strong> et <strong>RX</strong> du USB BUB vont clignoter un peu.</p>

<p>Ensuite, dans l&#39;IDE Arduino, va dans <code>Outils &gt; Port série</code> et sélectionne quelque chose comme <code>/dev/tty.usbserial-AH019ZSM</code>:</p>

<p><img src="/img/jeelink/arduino_04.png" alt="Jeenode avec USB HUB connecte"></p>

<p>Et enfin sélectionne <code>Outils &gt; Moniteur série</code>.</p>

<p>Si rien ne s&#39;affiche, c&#39;est peut etre un soucis de connexion, essaie de bouger un peu le JeeNode au niveau du connecteur FTDI. Si vraiment cela ne fonctionne pas, vérifie toutes les soudures de ton JeeNode.</p>

<p>Normalement tu dois voir le JeeNode causer avec toi comme le faisait le JeeLink. C&#39;est normal, c&#39;est parce qu&#39;il a été flashé avec le même sketch <code>RFM12demo</code>. Cela va nous permettre de le configurer correctement, cette fois-ci en lui donnant le numéro <strong>16</strong>:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">16i
8b
212g
</code></pre></div>
<p>Et voilà. Si tu as bien laissé le JeeLink connecté, on va pouvoir lui dire bonjour en tappant:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">15a
</code></pre></div>
<p>Ce qui veut dire &quot;Envoi un message de test au node 15 et demande un acquittement&quot;.</p>

<p>Ensuite on voit ça:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">-&gt; 0 b
</code></pre></div>
<p>Ce qui veut dire &quot;Ok, je viens d&#39;envoyer un message tout vide&quot;.</p>

<p>Et surtout, on recoit ce message:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">OK 143
</code></pre></div>
<p>Eh bien ça mon jeune ami, c&#39;est le JeeLink qui envoie un acquittement, ce qui signifie qu&#39;il a bien reçu ton message. Et là, normalement, tu pleures de joie tellement c&#39;est beau. Comment ça non ? Ah ok... eh ba moi non plus hein.</p>

<p><img src="/img/meme/meme_crying.png" alt="I shall not cry"></p>

<p>Si jamais tu ne reçois pas la réponse du JeeLink, vérifie que celui-ci n&#39;est pas en mode <strong>collect</strong>.</p>

<p>Ainsi s&#39;achève cet article.</p>

<p>Lors d&#39;un prochain épisode nous ajouterons un capteur au JeeNode.</p>

<p>A la prochain Etienne !</p>

<p>(Un pneu mon neveu hahahahaha.... haha... ha....)</p>

            </div>
        </div>
    </div>
</div>


        <footer>
          <div class="container-fluid">
            <div class="row footer">
              <div class="col-md-12">
                <p>
                  <a href="https://github.com/aymerick">github</a> |
                  <a href="https://twitter.com/aymerick">twitter</a> |
                  <a href="http://www.linkedin.com/in/aymerick">linkedin</a> |
                  <a href="https://careers.stackoverflow.com/aymerick">so careers</a> |
                  <a href="https://pinboard.in/u:aymerick">pinboard</a> |
                  <a href="http://fudahu.tumblr.com/">tumblr</a> |
                  <a href="http://www.flickr.com/photos/aymerick">flickr</a> |
                  <a href="http://www.youtube.com/ajehanne">youtube</a> |
                  <a href="http://soundcloud.com/aymerick-jehanne">soundcloud</a>
                </p>
              </div>
            </div>
          </div>
        </footer>

        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-52977462-1', 'auto');
          ga('send', 'pageview');
        </script>
    </body>
</html>
